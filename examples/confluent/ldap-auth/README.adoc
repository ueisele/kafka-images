= Confluent Server with Ldap Authentication and RBAC

Simplified variant of link:https://github.com/confluentinc/cp-demo[confluentinc/cp-demo], which soley focuses on the ldap authentication and authorization aspect. Compared to the demo, it also supports authentification of Kafka protocol via SASL/PLAIN with Ldap identities.

.Create certificate for MDS token signing
[source,bash]
----
./create-certs.sh
----

.Start services
[source,bash]
----
docker compose up -d openldap
docker compose up -d zookeeper1 zookeeper2 zookeeper3
docker compose up -d kafka-broker1 kafka-broker2 kafka-broker3
docker compose up -d kafka-cli
----

.Check Ldap
[source,bash]
----
docker compose exec openldap bash
ldapsearch -LLL -x -H ldap://openldap:389 -b 'dc=confluentdemo,dc=io' -D "cn=admin,dc=confluentdemo,dc=io" -w 'admin'
----

.Query cluster metadata
[source,bash]
----
docker compose exec kafka-cli bash
curl http://kafka-broker1:8090/v1/metadata/id
----

.Connect with superUser
[source,bash]
----
docker compose exec kafka-cli bash
kafka-topics --command-config /tmp/conf/superUser.config --bootstrap-server kafka:9092 --list
----

.Connect with appSA
[source,bash]
----
docker compose exec kafka-cli bash
kafka-topics --command-config /tmp/conf/appSA.config --bootstrap-server kafka:9092 --list
----

.Confluent Cli login
[source,bash]
----
docker compose exec confluent-cli bash
confluent login --url $MDS_URL
----

Login with user `superUser` and password `superUser`.

.Confluent Cli cluster describe
[source,bash]
----
docker compose exec confluent-cli bash
confluent cluster describe --url $MDS_URL
apk add jq
export CLUSTER_ID="$(confluent cluster describe --url $MDS_URL -o json | jq -r .crn)"
----

.Confluent Cli RBAC list
[source,bash]
----
docker compose exec confluent-cli bash
confluent iam rbac role list
confluent iam rbac role-binding list --kafka-cluster-id $CLUSTER_ID --principal User:appSA
----

.Confluent Cli RBAC grant topic permission to appSA
[source,bash]
----
docker compose exec confluent-cli bash
confluent iam rbac role-binding create \
    --principal User:appSA \
    --role DeveloperManage \
    --resource Topic:app- \
    --prefix \
    --kafka-cluster-id $CLUSTER_ID

confluent iam rbac role-binding create \
    --principal User:appSA \
    --role DeveloperWrite \
    --resource Topic:app- \
    --prefix \
    --kafka-cluster-id $CLUSTER_ID

confluent iam rbac role-binding create \
    --principal User:appSA \
    --role DeveloperRead \
    --resource Topic:app- \
    --prefix \
    --kafka-cluster-id $CLUSTER_ID
confluent iam rbac role-binding create \
    --principal User:appSA \
    --role DeveloperRead \
    --resource Group:app- \
    --prefix \
    --kafka-cluster-id $CLUSTER_ID

confluent iam rbac role-binding list --kafka-cluster-id $CLUSTER_ID --principal User:appSA
----

.Connect with appSA and create topic, produce and consume messages
[source,bash]
----
docker compose exec kafka-cli bash

kafka-topics --command-config /tmp/conf/appSA.config --bootstrap-server kafka:9092 \
    --create --topic app-topic-a --replication-factor 3 --partitions 3

kafka-topics --command-config /tmp/conf/appSA.config --bootstrap-server kafka:9092 --list

echo "test_message" | kafka-console-producer \
    --broker-list kafka:9092 \
    --topic app-topic-a \
    --producer.config /tmp/conf/appSA.config \
    --property parse.key=false

kafka-console-consumer \
    --bootstrap-server kafka:9092 \
    --topic app-topic-a \
    --group app-cg \
    --consumer.config /tmp/conf/appSA.config  \
    --from-beginning \
    --property parse.key=false \
    --max-messages 1
----

also see:

* link:https://docs.confluent.io/platform/current/security/rbac/rbac-cli-quickstart.html[RBAC Cli Quick Start]
* link:https://docs.confluent.io/platform/current/security/rbac/rbac-predefined-roles.html[RBAC predefined roles]